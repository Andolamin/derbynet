<!DOCTYPE html>
<html>
<?php
require_once('inc/photo-config.inc');
?>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>DerbyNet Software</title>
    <script type="text/javascript" src="js/jquery.js"></script>
<?php require('inc/kiosk-page.inc'); ?>
<?php require('inc/stylesheet.inc'); ?>
    <link rel="stylesheet" type="text/css" href="css/slideshow.css"/>
    <script type="text/javascript">
    // We don't know the actual rendered size of the main photo until after it's loaded, so that's
    // when we can calculate how much margin to apply to the main photo.
    function mainphoto_onload(img) {
      var top_margin = ($("#photo-background").height() - img.height) / 2;
      $("#photo-background .mainphoto").css('margin-top', top_margin);
    }
    // 
    function refresh_page(racer) {
      var div = $("#photo-background");
      div.empty();
      if (racer) {
        div.append('<img class="mainphoto" onload="mainphoto_onload(this)" src="' +
                   racer.getAttribute('main_photo') + '"/>');
        div.append('<p class="subtitle">' + 
                   '<span class="carno">' + racer.getAttribute('carnumber') + '</span>: ' +
                   racer.getAttribute('firstname') + ' ' + racer.getAttribute('lastname') +
                   (racer.getAttribute('carname') ?
                    '<br/><i>' + racer.getAttribute('carname') + '</i>' : '') +
                   '</p>');
        if (racer.hasAttribute('inset_photo')) {
          div.append('<img class="inset_photo" src="' +
                     racer.getAttribute('inset_photo') + '"/>');
        }
        // Preload the next image for better display
        if (racer.hasAttribute('next_photo')) {
          div.append('<img style="display: none;" src="' +
                     racer.getAttribute('next_photo') + '"/>');
        }
      } else {
          div.append('<img class="mainphoto" onload="mainphoto_onload(this)" src="img/derby_car.png"/>');
      }
    }

    var g_racerid = 0;
    function photo_poll() {
      $.ajax('action.php',
      {type: 'GET',
        data: {query: 'photo.next',
               racerid: g_racerid},
        success: function(data) {
          var racers = data.getElementsByTagName("racer");
          if (racers.length > 0) {
            g_racerid = racers[0].getAttribute('racerid');
            refresh_page(racers[0]);
          } else {
            g_racerid = 0;
            refresh_page(null);
          }
        }
      }
        );
    }
$(document).ready(function() {
    photo_poll();
    setInterval(photo_poll, 10000);
  });
    </script>
  </head>

  <body>

  <div id="photo-background" class="photo-background">
  </div>

  </body>
</html>
